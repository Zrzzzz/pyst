{% extends "base.html" %}

{% block title %}é¦–é¡µ - è‚¡ç¥¨å¼‚åŠ¨ç›‘æ§{% endblock %}

{% block extra_css %}
<style>
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-message {
        padding: 20px;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 4px solid var(--danger-color);
        border-radius: 8px;
        color: #7f1d1d;
        margin: 20px 0;
    }
</style>
<style>
    .section {
        margin-bottom: 50px;
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-box {
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
        border-left: 4px solid var(--info-color);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
    }

    .info-box p {
        color: var(--info-color);
        margin: 0;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: var(--shadow-md);
    }

    .market-badge {
        display: inline-block;
        padding: 6px 12px;
        background: var(--bg-lighter);
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: 500;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .market-badge:hover {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary-light);
    }

    .limit-up-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-radius: 6px;
        font-weight: 600;
        color: #92400e;
        border: 1px solid #fcd34d;
        font-size: 0.85em;
    }

    .date-range {
        font-size: 0.85em;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .divider {
        margin: 50px 0;
        border: none;
        border-top: 2px solid var(--border-color);
        opacity: 0.5;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 10px;
        opacity: 0.5;
    }

    .metrics-cell {
        font-size: 0.85em;
        line-height: 1.5;
        background: var(--bg-lighter);
        padding: 10px !important;
        border-radius: 4px;
    }

    .metrics-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .metrics-label {
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 60px;
    }

    .metrics-value {
        font-weight: 600;
        text-align: right;
    }

    .metrics-divider {
        margin: 6px 0;
        padding: 6px 0;
        border-top: 1px solid var(--border-color);
    }

    .expand-btn {
        cursor: pointer;
        color: var(--primary-color);
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        user-select: none;
    }

    .expand-btn:hover {
        background: var(--primary-light);
        color: white;
    }

    .detail-row {
        display: none;
        background: var(--bg-lighter);
    }

    .detail-row.show {
        display: table-row;
    }

    .detail-content {
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
    }

    .t-plus-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-top: 10px;
        width: 100%;
    }

    .t-plus-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        font-size: 0.85em;
    }

    .t-plus-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .t-plus-title {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 0.95em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .t-plus-item {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
        font-size: 0.85em;
    }

    .t-plus-label {
        color: var(--text-secondary);
    }

    .t-plus-value {
        font-weight: 600;
    }

    .abnormal-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 600;
    }

    .abnormal-badge.yes {
        background: #fee2e2;
        color: #dc2626;
    }

    .abnormal-badge.no {
        background: #d1fae5;
        color: #059669;
    }

    .edit-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.7em;
        padding: 2px 4px;
        margin-left: 4px;
        transition: all 0.2s ease;
        border-radius: 3px;
        white-space: nowrap;
    }

    .edit-btn:hover {
        background: var(--primary-light);
        color: white;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 400px;
        width: 90%;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        font-size: 1.2em;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--text-primary);
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95em;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95em;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-hint {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95em;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: var(--bg-lighter);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h2 class="section-title">ğŸ“Š 10æ—¥åç¦»å€¼æ¦œ Top 30</h2>

    <div class="info-box">
        <p>
            ğŸ’¡ <strong>åç¦»å€¼</strong> = è‚¡ç¥¨æ¶¨å¹…(%) - æŒ‡æ•°æ¶¨å¹…(%) | æ­£å€¼è¡¨ç¤ºè‚¡ç¥¨å¼ºäºæŒ‡æ•°ï¼Œè´Ÿå€¼è¡¨ç¤ºè‚¡ç¥¨å¼±äºæŒ‡æ•°
        </p>
    </div>

    <div id="table-10-new-container" class="table-wrapper">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<hr class="divider">

<div class="section">
    <h2 class="section-title">ğŸ“ˆ 30æ—¥åç¦»å€¼æ¦œ Top 30</h2>

    <div class="info-box">
        <p>
            ğŸ’¡ <strong>åç¦»å€¼</strong> = è‚¡ç¥¨æ¶¨å¹…(%) - æŒ‡æ•°æ¶¨å¹…(%) | æ­£å€¼è¡¨ç¤ºè‚¡ç¥¨å¼ºäºæŒ‡æ•°ï¼Œè´Ÿå€¼è¡¨ç¤ºè‚¡ç¥¨å¼±äºæŒ‡æ•°
        </p>
    </div>

    <div id="table-30-new-container" class="table-wrapper">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>



<script src="/static/stock_deviation.js"></script>
<script>
// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    loadBothTables();
});

async function loadBothTables() {
    try {
        const response = await fetch('/api/stocks/both');
        const result = await response.json();

        if (result.code === 0) {
            // æ–°æ¦œå•ï¼šä½¿ç”¨JSå‡½æ•°è®¡ç®—T+1~T+5
            renderTableWithJSCalculation('table-10-new-container', result.data.stocks_10, '10æ—¥åç¦»', 'period_10_new', 5);
            renderTableWithJSCalculation('table-30-new-container', result.data.stocks_30, '30æ—¥åç¦»', 'period_30_new', 5);
        } else {
            showError('table-10-new-container', result.message);
            showError('table-30-new-container', result.message);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showError('table-10-new-container', 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
        showError('table-30-new-container', 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
    }
}

function renderTableWithJSCalculation(containerId, data, periodLabel, period, maxTPlusDays = 6) {
    const container = document.getElementById(containerId);

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— æ•°æ®</p></div>';
        return;
    }

    // æ ¹æ®periodç¡®å®šåŸºç¡€å¤©æ•°
    const baseDays = period.includes('30') ? 30 : 10;

    let html = '<table><thead><tr>';
    html += '<th style="width: 60px;">æ’å</th>';
    html += '<th>è‚¡ç¥¨ä»£ç </th>';
    html += '<th>è‚¡ç¥¨åç§°</th>';
    html += '<th>å¸‚åœºç±»å‹</th>';
    html += '<th>ç°ä»·</th>';
    html += '<th>æœ€ä½ä»·</th>';
    html += '<th>ç´¯è®¡æ¶¨å¹…</th>';
    html += '<th>æŒ‡æ•°æ¶¨å¹…</th>';
    html += `<th>${periodLabel}</th>`;
    html += `<th>T+1/T+2åç¦»(JSè®¡ç®—)</th>`;
    html += '<th>äº¤æ˜“æ—¥å‘¨æœŸ</th>';
    html += '<th>æ—¥æœŸèŒƒå›´</th>';
    html += '<th style="width: 80px;">è¯¦æƒ…</th>';
    html += '</tr></thead><tbody>';

    data.forEach((item, index) => {
        const priceChangeClass = item.price_change_pct >= 0 ? 'positive' : 'negative';
        const indexChangeClass = item.index_change_pct >= 0 ? 'positive' : 'negative';
        const deviationClass = item.deviation >= 0 ? 'positive' : 'negative';
        const rowId = `row-${period}-${index}`;

        // ä½¿ç”¨JSå‡½æ•°è®¡ç®—T+1å’ŒT+2çš„åç¦»å€¼
        // ç”Ÿæˆæ¨¡æ‹Ÿæ¶¨åœä»·æ ¼
        const lastPrice = item.stock_prices[item.stock_prices.length - 1].close;
        const limitUpPct = item.limit_up;

        // è·å–æœ€ä½ä»·
        let lowestPrice = item.stock_prices[0].pre_close;
        for (let i = 1; i < item.stock_prices.length; i++) {
            if (item.stock_prices[i].pre_close < lowestPrice) {
                lowestPrice = item.stock_prices[i].pre_close;
            }
        }

        const t1ExtraPrices = generateLimitUpPrices(lastPrice, limitUpPct, 1);
        const t2ExtraPrices = generateLimitUpPrices(lastPrice, limitUpPct, 2);

        const t1Result = calculateTrailingDeviation(item.stock_prices, item.index_prices, baseDays, t1ExtraPrices);
        const t2Result = calculateTrailingDeviation(item.stock_prices, item.index_prices, baseDays, t2ExtraPrices);

        const t1Deviation = t1Result.success ? t1Result.deviation : null;
        const t2Deviation = t2Result.success ? t2Result.deviation : null;

        // åˆ¤æ–­æ˜¯å¦å¼‚åŠ¨
        const threshold = item.threshold || 100;
        const t1IsAbnormal = t1Deviation !== null && t1Deviation > threshold;
        const t2IsAbnormal = t2Deviation !== null && t2Deviation > threshold;

        const t1DeviationClass = t1Deviation !== null && t1Deviation >= 0 ? 'positive' : 'negative';
        const t2DeviationClass = t2Deviation !== null && t2Deviation >= 0 ? 'positive' : 'negative';
        const t1AbnormalClass = t1IsAbnormal ? 'yes' : 'no';
        const t2AbnormalClass = t2IsAbnormal ? 'yes' : 'no';
        const t1AbnormalText = t1IsAbnormal ? 'âœ“' : 'âœ—';
        const t2AbnormalText = t2IsAbnormal ? 'âœ“' : 'âœ—';

        // ä¸»æ•°æ®è¡Œ
        html += `<tr data-ts-code="${item.ts_code}" data-market="${item.market}" data-stock-prices='${JSON.stringify(item.stock_prices)}' data-index-prices='${JSON.stringify(item.index_prices)}' data-period="${period}" data-limit-up="${item.limit_up}" data-threshold="${item.threshold || 100}" data-base-days="${baseDays}" data-max-t-plus-days="${maxTPlusDays}">`;
        html += `<td class="rank">${index + 1}</td>`;
        html += `<td style="font-weight: 600; color: var(--primary-color);">${item.ts_code}</td>`;
        html += `<td style="font-weight: 500;">${item.name}</td>`;
        html += `<td><span class="market-badge">${item.market}</span></td>`;
        html += `<td style="text-align: right; font-weight: 600;">${lastPrice.toFixed(2)}</td>`;
        html += `<td style="text-align: right; font-weight: 600;">${lowestPrice.toFixed(2)}</td>`;
        html += `<td><span class="${priceChangeClass}">${item.price_change_pct.toFixed(2)}%</span></td>`;
        html += `<td><span class="${indexChangeClass}">${item.index_change_pct.toFixed(2)}%</span></td>`;
        html += `<td><span class="${deviationClass}" style="font-weight: 700; font-size: 1.05em;">${item.deviation.toFixed(2)}%</span></td>`;
        html += `<td class="metrics-cell">
            <div class="metrics-row">
                <span class="metrics-label">T+1:</span>
                <span class="metrics-value ${t1DeviationClass}">${t1Deviation !== null ? t1Deviation.toFixed(2) : 'N/A'}%</span>
                <span class="abnormal-badge ${t1AbnormalClass}" style="margin-left: 4px;">${t1AbnormalText}</span>
            </div>
            <div class="metrics-row">
                <span class="metrics-label">T+2:</span>
                <span class="metrics-value ${t2DeviationClass}">${t2Deviation !== null ? t2Deviation.toFixed(2) : 'N/A'}%</span>
                <span class="abnormal-badge ${t2AbnormalClass}" style="margin-left: 4px;">${t2AbnormalText}</span>
            </div>
        </td>`;
        html += `<td style="text-align: center; font-weight: 600; color: var(--primary-color);">${item.deviation_date_range || 'N/A'}</td>`;
        html += `<td class="date-range">${item.low_date || 'N/A'} ~ ${item.end_date || 'N/A'}</td>`;
        html += `<td style="text-align: center;"><span class="expand-btn" onclick="toggleDetail('${rowId}')">â–¼ å±•å¼€</span></td>`;
        html += '</tr>';

        // è¯¦ç»†ä¿¡æ¯è¡Œ - ä½¿ç”¨JSè®¡ç®—çš„T+1åˆ°T+maxTPlusDaysæ•°æ®
        html += `<tr class="detail-row" id="${rowId}">`;
        html += `<td colspan="13">`;
        html += `<div class="detail-content">`;
        html += `<h4 style="margin-top: 0; color: var(--primary-color);">T+i åç¦»å€¼æ•°æ® (JSåŠ¨æ€è®¡ç®—)</h4>`;
        html += renderTPlusDataWithJSCalculation(item, maxTPlusDays, baseDays, item.threshold || 100);
        html += `</div>`;
        html += `</td>`;
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}





function showError(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="error-message">åŠ è½½å¤±è´¥: ${message}</div>`;
}

function renderTPlusDataWithJSCalculation(item, maxTPlusDays = 6, baseDays = 10, threshold = 100) {
    let html = '<div class="t-plus-grid" id="t-plus-grid-' + item.ts_code + '">';

    // è·å–æœ€åä¸€å¤©çš„æ”¶ç›˜ä»·å’Œæ¶¨åœå¹…åº¦
    const lastPrice = item.stock_prices[item.stock_prices.length - 1].close;
    const limitUpPct = item.limit_up;

    // å­˜å‚¨ä¿®æ”¹åçš„æ¶¨å¹…ï¼ˆç”¨äºçº§è”è®¡ç®—ï¼‰
    const modifiedPrices = {};

    // æ¸²æŸ“ t+1 åˆ° t+maxTPlusDaysï¼Œä½¿ç”¨JSå‡½æ•°åŠ¨æ€è®¡ç®—
    for (let i = 1; i <= maxTPlusDays; i++) {
        // ç”Ÿæˆæ¨¡æ‹Ÿæ¶¨åœä»·æ ¼
        const extraPrices = generateLimitUpPrices(lastPrice, limitUpPct, i);
        const result = calculateTrailingDeviation(item.stock_prices, item.index_prices, baseDays, extraPrices);

        if (result.success) {
            const stockChangePercent = result.stock.changePercent;
            const indexChangePercent = result.index.changePercent;
            const deviation = result.deviation;

            // è®¡ç®—å½“æ—¥æ¶¨å¹…ï¼ˆT+nç›¸å¯¹äºT+n-1çš„æ¶¨å¹…ï¼‰
            let dailyChangePercent = 0;
            if (i === 1) {
                // T+1çš„å½“æ—¥æ¶¨å¹… = (T+1æ”¶ç›˜ä»· - æœ€åä¸€å¤©æ”¶ç›˜ä»·) / æœ€åä¸€å¤©æ”¶ç›˜ä»· * 100
                dailyChangePercent = ((extraPrices[0] - lastPrice) / lastPrice) * 100;
            } else {
                // T+nçš„å½“æ—¥æ¶¨å¹… = (T+næ”¶ç›˜ä»· - T+n-1æ”¶ç›˜ä»·) / T+n-1æ”¶ç›˜ä»· * 100
                const prevPrice = extraPrices[i - 2];
                dailyChangePercent = ((extraPrices[i - 1] - prevPrice) / prevPrice) * 100;
            }

            // åˆ¤æ–­æ˜¯å¦å¼‚åŠ¨
            const isAbnormal = deviation > threshold;

            const priceChangeClass = stockChangePercent >= 0 ? 'positive' : 'negative';
            const dailyChangeClass = dailyChangePercent >= 0 ? 'positive' : 'negative';
            const deviationClass = deviation >= 0 ? 'positive' : 'negative';
            const abnormalClass = isAbnormal ? 'yes' : 'no';
            const abnormalText = isAbnormal ? 'æ˜¯' : 'å¦';

            const cardId = `t-plus-card-${item.ts_code}-${i}`;
            html += `<div class="t-plus-card" id="${cardId}">`;
            html += `<div class="t-plus-title">T+${i} <button class="edit-btn" onclick="openEditModal('${item.ts_code}', ${i}, ${limitUpPct}, ${lastPrice}, ${baseDays}, ${maxTPlusDays})">âœï¸ ä¿®æ”¹</button></div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æœ€ä½ä»·:</span>`;
            html += `<span class="t-plus-value">${result.stock.lowestPreClose.toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ—¥æœŸ:</span>`;
            html += `<span class="t-plus-value">${result.stock.lowestDate}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ¶¨åœä»·:</span>`;
            html += `<span class="t-plus-value" id="current-close-${item.ts_code}-${i}">${result.stock.currentClose.toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value ${priceChangeClass}" id="price-change-${item.ts_code}-${i}">${stockChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å½“æ—¥æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value ${dailyChangeClass}" id="daily-change-${item.ts_code}-${i}">${dailyChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æŒ‡æ•°æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value" id="index-change-${item.ts_code}-${i}">${indexChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">åç¦»å€¼:</span>`;
            html += `<span class="t-plus-value ${deviationClass}" id="deviation-${item.ts_code}-${i}">${deviation.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å¼‚åŠ¨:</span>`;
            html += `<span class="abnormal-badge ${abnormalClass}" id="abnormal-${item.ts_code}-${i}">${abnormalText}</span>`;
            html += `</div>`;
            html += `</div>`;
        } else {
            html += `<div class="t-plus-card">`;
            html += `<div class="t-plus-title">T+${i}</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">é”™è¯¯:</span>`;
            html += `<span class="t-plus-value">${result.error}</span>`;
            html += `</div>`;
            html += `</div>`;
        }
    }

    html += '</div>';
    return html;
}



function toggleDetail(rowId) {
    const detailRow = document.getElementById(rowId);
    const btn = event.target;

    if (detailRow.classList.contains('show')) {
        detailRow.classList.remove('show');
        btn.textContent = 'â–¼ å±•å¼€';
    } else {
        detailRow.classList.add('show');
        btn.textContent = 'â–² æ”¶èµ·';
    }
}

// å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ•°æ®
let currentEditData = {
    tsCode: null,
    tPlusDay: null,
    limitUpPct: null,
    lastPrice: null,
    baseDays: null,
    maxTPlusDays: null,
    modifiedPrices: {} // å­˜å‚¨ä¿®æ”¹åçš„æ¶¨å¹…
};

function openEditModal(tsCode, tPlusDay, limitUpPct, lastPrice, baseDays, maxTPlusDays) {
    // è·å–è¡¨æ ¼è¡Œæ•°æ®
    const tableRow = document.querySelector(`tr[data-ts-code="${tsCode}"]`);
    const threshold = tableRow ? parseFloat(tableRow.getAttribute('data-threshold')) : 100;
    const stockPrices = tableRow ? JSON.parse(tableRow.getAttribute('data-stock-prices')) : [];
    const indexPrices = tableRow ? JSON.parse(tableRow.getAttribute('data-index-prices')) : [];

    currentEditData = {
        tsCode: tsCode,
        tPlusDay: tPlusDay,
        limitUpPct: limitUpPct,
        lastPrice: lastPrice,
        baseDays: baseDays,
        maxTPlusDays: maxTPlusDays,
        threshold: threshold,
        stockPrices: stockPrices,
        indexPrices: indexPrices
    };

    // è·å–å½“å‰çš„å½“æ—¥æ¶¨å¹…å€¼
    const dailyChangeElement = document.getElementById(`daily-change-${tsCode}-${tPlusDay}`);
    const currentValue = dailyChangeElement ? parseFloat(dailyChangeElement.textContent) : 0;

    // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
    document.getElementById('editModalTitle').textContent = `ä¿®æ”¹ ${tsCode} T+${tPlusDay} å½“æ—¥æ¶¨å¹…`;
    document.getElementById('priceChangeInput').value = currentValue.toFixed(2);

    // è®¾ç½®èŒƒå›´æç¤º
    const minValue = -limitUpPct;
    const maxValue = limitUpPct;
    document.getElementById('rangeHint').textContent = `èŒƒå›´: ${minValue.toFixed(2)}% ~ ${maxValue.toFixed(2)}%`;

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function saveModification() {
    const newValue = parseFloat(document.getElementById('priceChangeInput').value);
    const limitUpPct = currentEditData.limitUpPct;
    const minValue = -limitUpPct;
    const maxValue = limitUpPct;

    // éªŒè¯è¾“å…¥
    if (isNaN(newValue)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
        return;
    }

    if (newValue < minValue || newValue > maxValue) {
        alert(`æ¶¨å¹…å¿…é¡»åœ¨ ${minValue.toFixed(2)}% åˆ° ${maxValue.toFixed(2)}% ä¹‹é—´`);
        return;
    }

    // ä¿å­˜ä¿®æ”¹å¹¶é‡æ–°è®¡ç®—åç»­æ•°æ®
    recalculateTPlusData(newValue);
    closeEditModal();
}

function recalculateTPlusData(modifiedDailyChange) {
    const { tsCode, tPlusDay, limitUpPct, baseDays, maxTPlusDays, threshold, stockPrices, indexPrices, lastPrice } = currentEditData;

    // è·å–T+tPlusDayå‰ä¸€å¤©çš„ä»·æ ¼
    let prevPrice;
    if (tPlusDay === 1) {
        prevPrice = lastPrice;
    } else {
        // ç”ŸæˆT+tPlusDay-1çš„ä»·æ ¼
        const prevExtraPrices = generateLimitUpPrices(lastPrice, limitUpPct, tPlusDay - 1);
        prevPrice = prevExtraPrices[tPlusDay - 2];
    }

    // è®¡ç®—ä¿®æ”¹åçš„ä»·æ ¼ï¼ˆåŸºäºå‰ä¸€å¤©ä»·æ ¼å’Œå½“æ—¥æ¶¨å¹…ï¼‰
    const modifiedPrice = prevPrice * (1 + modifiedDailyChange / 100);

    // ç”Ÿæˆä»ä¿®æ”¹ç‚¹å¼€å§‹çš„æ–°ä»·æ ¼åºåˆ—
    let currentPrice = modifiedPrice;
    const newExtraPrices = [modifiedPrice];

    // å¯¹äº T+tPlusDay ä¹‹åçš„å¤©æ•°ï¼Œç»§ç»­æ¶¨åœ
    for (let i = tPlusDay + 1; i <= maxTPlusDays; i++) {
        currentPrice = currentPrice * (1 + limitUpPct / 100);
        newExtraPrices.push(parseFloat(currentPrice.toFixed(2)));
    }

    // é‡æ–°è®¡ç®— T+tPlusDay åˆ° T+maxTPlusDays çš„æ•°æ®
    for (let i = tPlusDay; i <= maxTPlusDays; i++) {
        // ç”Ÿæˆåˆ°ç¬¬ i å¤©çš„ä»·æ ¼åºåˆ—
        const extraPrices = newExtraPrices.slice(0, i - tPlusDay + 1);

        // è®¡ç®—åç¦»å€¼
        const result = calculateTrailingDeviation(stockPrices, indexPrices, baseDays, extraPrices);

        if (result.success) {
            const stockChangePercent = result.stock.changePercent;
            const indexChangePercent = result.index.changePercent;
            const deviation = result.deviation;
            const isAbnormal = deviation > threshold;

            // è®¡ç®—å½“æ—¥æ¶¨å¹…
            let dailyChangePercent = 0;
            if (i === tPlusDay) {
                // ä¿®æ”¹çš„é‚£ä¸€å¤©ï¼Œå½“æ—¥æ¶¨å¹… = (ä¿®æ”¹åçš„ä»·æ ¼ - å‰ä¸€å¤©ä»·æ ¼) / å‰ä¸€å¤©ä»·æ ¼ * 100
                const prevPrice = tPlusDay === 1 ? lastPrice : newExtraPrices[0];
                dailyChangePercent = ((extraPrices[0] - prevPrice) / prevPrice) * 100;
            } else {
                // åç»­å¤©æ•°ï¼Œå½“æ—¥æ¶¨å¹… = (T+næ”¶ç›˜ä»· - T+n-1æ”¶ç›˜ä»·) / T+n-1æ”¶ç›˜ä»· * 100
                const prevPrice = extraPrices[i - tPlusDay - 1];
                dailyChangePercent = ((extraPrices[i - tPlusDay] - prevPrice) / prevPrice) * 100;
            }

            // æ›´æ–°UI
            const currentCloseElement = document.getElementById(`current-close-${tsCode}-${i}`);
            const priceChangeElement = document.getElementById(`price-change-${tsCode}-${i}`);
            const dailyChangeElement = document.getElementById(`daily-change-${tsCode}-${i}`);
            const indexChangeElement = document.getElementById(`index-change-${tsCode}-${i}`);
            const deviationElement = document.getElementById(`deviation-${tsCode}-${i}`);
            const abnormalElement = document.getElementById(`abnormal-${tsCode}-${i}`);

            if (currentCloseElement) {
                currentCloseElement.textContent = result.stock.currentClose.toFixed(2);
            }

            if (priceChangeElement) {
                priceChangeElement.textContent = stockChangePercent.toFixed(2) + '%';
                priceChangeElement.className = `t-plus-value ${stockChangePercent >= 0 ? 'positive' : 'negative'}`;
            }

            if (dailyChangeElement) {
                dailyChangeElement.textContent = dailyChangePercent.toFixed(2) + '%';
                dailyChangeElement.className = `t-plus-value ${dailyChangePercent >= 0 ? 'positive' : 'negative'}`;
            }

            if (indexChangeElement) {
                indexChangeElement.textContent = indexChangePercent.toFixed(2) + '%';
            }

            if (deviationElement) {
                deviationElement.textContent = deviation.toFixed(2) + '%';
                deviationElement.className = `t-plus-value ${deviation >= 0 ? 'positive' : 'negative'}`;
            }

            if (abnormalElement) {
                abnormalElement.textContent = isAbnormal ? 'æ˜¯' : 'å¦';
                abnormalElement.className = `abnormal-badge ${isAbnormal ? 'yes' : 'no'}`;
            }
        }
    }
}

// å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeEditModal();
            }
        });
    }

    // å›è½¦ä¿å­˜
    const input = document.getElementById('priceChangeInput');
    if (input) {
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveModification();
            }
        });
    }
});
</script>

<!-- ä¿®æ”¹æ¶¨å¹…çš„æ¨¡æ€æ¡† -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="editModalTitle">ä¿®æ”¹æ¶¨å¹…</div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ä¿®æ”¹æ¶¨å¹… (%)</label>
                <input type="number" id="priceChangeInput" class="form-input" step="0.01" placeholder="è¾“å…¥æ¶¨å¹…ç™¾åˆ†æ¯”">
                <div class="form-hint" id="rangeHint">èŒƒå›´: -10% ~ 50%</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveModification()">ä¿å­˜</button>
        </div>
    </div>
</div>

{% endblock %}

