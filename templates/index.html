{% extends "base.html" %}

{% block title %}é¦–é¡µ - è‚¡ç¥¨å¼‚åŠ¨ç›‘æ§{% endblock %}

{% block extra_css %}
<style>
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-message {
        padding: 20px;
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-left: 4px solid var(--danger-color);
        border-radius: 8px;
        color: #7f1d1d;
        margin: 20px 0;
    }
</style>
<style>
    .section {
        margin-bottom: 50px;
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        color: var(--text-primary);
        margin-bottom: 20px;
        font-size: 1.5em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-box {
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
        border-left: 4px solid var(--info-color);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
    }

    .info-box p {
        color: var(--info-color);
        margin: 0;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: var(--shadow-md);
    }

    .market-badge {
        display: inline-block;
        padding: 6px 12px;
        background: var(--bg-lighter);
        border-radius: 6px;
        font-size: 0.85em;
        font-weight: 500;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .market-badge:hover {
        background: var(--primary-light);
        color: white;
        border-color: var(--primary-light);
    }

    .limit-up-badge {
        display: inline-block;
        padding: 6px 12px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-radius: 6px;
        font-weight: 600;
        color: #92400e;
        border: 1px solid #fcd34d;
        font-size: 0.85em;
    }

    .date-range {
        font-size: 0.85em;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    .divider {
        margin: 50px 0;
        border: none;
        border-top: 2px solid var(--border-color);
        opacity: 0.5;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 10px;
        opacity: 0.5;
    }

    .metrics-cell {
        font-size: 0.85em;
        line-height: 1.5;
        background: var(--bg-lighter);
        padding: 10px !important;
        border-radius: 4px;
    }

    .metrics-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
    }

    .metrics-label {
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 60px;
    }

    .metrics-value {
        font-weight: 600;
        text-align: right;
    }

    .metrics-divider {
        margin: 6px 0;
        padding: 6px 0;
        border-top: 1px solid var(--border-color);
    }

    .expand-btn {
        cursor: pointer;
        color: var(--primary-color);
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        user-select: none;
    }

    .expand-btn:hover {
        background: var(--primary-light);
        color: white;
    }

    .detail-row {
        display: none;
        background: var(--bg-lighter);
    }

    .detail-row.show {
        display: table-row;
    }

    .detail-content {
        padding: 20px;
        width: 100%;
        box-sizing: border-box;
    }

    .t-plus-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-top: 10px;
        width: 100%;
    }

    .t-plus-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        font-size: 0.85em;
    }

    .t-plus-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .t-plus-title {
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 8px;
        font-size: 0.95em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .t-plus-item {
        display: flex;
        justify-content: space-between;
        margin: 4px 0;
        font-size: 0.85em;
    }

    .t-plus-label {
        color: var(--text-secondary);
    }

    .t-plus-value {
        font-weight: 600;
    }

    .abnormal-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75em;
        font-weight: 600;
    }

    .abnormal-badge.yes {
        background: #fee2e2;
        color: #dc2626;
    }

    .abnormal-badge.no {
        background: #d1fae5;
        color: #059669;
    }

    .edit-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        font-size: 0.7em;
        padding: 2px 4px;
        margin-left: 4px;
        transition: all 0.2s ease;
        border-radius: 3px;
        white-space: nowrap;
    }

    .edit-btn:hover {
        background: var(--primary-light);
        color: white;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
    }

    .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        max-width: 400px;
        width: 90%;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        font-size: 1.2em;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--text-primary);
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.95em;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.95em;
        box-sizing: border-box;
        transition: all 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-hint {
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-top: 4px;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.95em;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background: var(--bg-lighter);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h2 class="section-title">ğŸ“Š 10æ—¥åç¦»å€¼æ¦œ Top 30</h2>

    <div class="info-box">
        <p>
            ğŸ’¡ <strong>åç¦»å€¼</strong> = è‚¡ç¥¨æ¶¨å¹…(%) - æŒ‡æ•°æ¶¨å¹…(%) | æ­£å€¼è¡¨ç¤ºè‚¡ç¥¨å¼ºäºæŒ‡æ•°ï¼Œè´Ÿå€¼è¡¨ç¤ºè‚¡ç¥¨å¼±äºæŒ‡æ•°
        </p>
    </div>

    <div id="table-10-new-container" class="table-wrapper">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<hr class="divider">

<div class="section">
    <h2 class="section-title">ğŸ“ˆ 30æ—¥åç¦»å€¼æ¦œ Top 30</h2>

    <div class="info-box">
        <p>
            ğŸ’¡ <strong>åç¦»å€¼</strong> = è‚¡ç¥¨æ¶¨å¹…(%) - æŒ‡æ•°æ¶¨å¹…(%) | æ­£å€¼è¡¨ç¤ºè‚¡ç¥¨å¼ºäºæŒ‡æ•°ï¼Œè´Ÿå€¼è¡¨ç¤ºè‚¡ç¥¨å¼±äºæŒ‡æ•°
        </p>
    </div>

    <div id="table-30-new-container" class="table-wrapper">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>



<script src="/static/stock_deviation.js"></script>
<script>
// é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    loadBothTables();
});

async function loadBothTables() {
    try {
        const response = await fetch('/api/stocks/both');
        const result = await response.json();

        if (result.code === 0) {
            // ä¿å­˜åŸå§‹æ•°æ®åˆ°å…¨å±€å˜é‡
            stocksData_10.length = 0;  // æ¸…ç©ºæ•°ç»„
            stocksData_30.length = 0;
            stocksData_10.push(...result.data.stocks_10);
            stocksData_30.push(...result.data.stocks_30);

            // æ–°æ¦œå•ï¼šä½¿ç”¨JSå‡½æ•°è®¡ç®—T+1~T+5
            renderTableWithJSCalculation('table-10-new-container', result.data.stocks_10, '10æ—¥åç¦»', 'period_10_new', 5);
            renderTableWithJSCalculation('table-30-new-container', result.data.stocks_30, '30æ—¥åç¦»', 'period_30_new', 5);

            // åœ¨ä¸¤ä¸ªæ¦œå•éƒ½æ¸²æŸ“å®Œæˆåï¼Œæ·»åŠ å¦ä¸€æ¦œå•çš„å¼‚åŠ¨ä¿¡æ¯
            addCrossListAbnormalInfo();
        } else {
            showError('table-10-new-container', result.message);
            showError('table-30-new-container', result.message);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        showError('table-10-new-container', 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
        showError('table-30-new-container', 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
    }
}

function renderTableWithJSCalculation(containerId, data, periodLabel, period, maxTPlusDays = 6) {
    const container = document.getElementById(containerId);

    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>æš‚æ— æ•°æ®</p></div>';
        return;
    }

    // æ ¹æ®periodç¡®å®šåŸºç¡€å¤©æ•°å’Œå¯¹åº”çš„ä¿®æ”¹å­—å…¸
    const baseDays = period.includes('30') ? 30 : 10;
    const stockModifiedChanges = period.includes('30') ? stockModifiedChanges_30 : stockModifiedChanges_10;

    // ä¸ºæ¯ä¸ªè‚¡ç¥¨é¢„å…ˆè®¡ç®—æ¶¨å¹…æ•°ç»„ï¼Œå¹¶å­˜å‚¨åˆ° stockDetailsMap
    data.forEach((item) => {
        const tsCode = item.ts_code;
        const limitUpPct = item.limit_up;

        // å­˜å‚¨è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯åˆ° stockDetailsMap
        stockDetailsMap[period][tsCode] = {
            stock_prices: item.stock_prices,
            index_prices: item.index_prices,
            limit_up: item.limit_up,
            threshold: item.threshold || 100,
            last_price: item.stock_prices[item.stock_prices.length - 1].close,
            base_days: item.stock_prices.length,  // ä½¿ç”¨å®é™…æ•°æ®é•¿åº¦
            max_t_plus_days: maxTPlusDays
        };

        // å¦‚æœè¯¥è‚¡ç¥¨è¿˜æ²¡æœ‰åˆå§‹åŒ–æ¶¨å¹…æ•°æ®ï¼Œåˆ™åˆå§‹åŒ–ä¸ºé»˜è®¤æ¶¨åœå¹…åº¦
        if (!stockModifiedChanges[tsCode]) {
            stockModifiedChanges[tsCode] = {};
            // é¢„å…ˆå¡«å……æ‰€æœ‰T+1åˆ°T+maxTPlusDaysçš„é»˜è®¤æ¶¨å¹…
            for (let i = 1; i <= maxTPlusDays; i++) {
                stockModifiedChanges[tsCode][i] = limitUpPct;
            }
        }
    });

    let html = '<table><thead><tr>';
    html += '<th style="width: 60px;">æ’å</th>';
    html += '<th>è‚¡ç¥¨ä»£ç </th>';
    html += '<th>è‚¡ç¥¨åç§°</th>';
    html += '<th>å¸‚åœºç±»å‹</th>';
    html += '<th>ç°ä»·</th>';
    html += '<th>æœ€ä½ä»·</th>';
    html += '<th>ç´¯è®¡æ¶¨å¹…</th>';
    html += '<th>æŒ‡æ•°æ¶¨å¹…</th>';
    html += `<th>${periodLabel}</th>`;
    html += `<th>T+1/T+2åç¦»(JSè®¡ç®—)</th>`;
    html += '<th>äº¤æ˜“æ—¥å‘¨æœŸ</th>';
    html += '<th>æ—¥æœŸèŒƒå›´</th>';
    html += '<th style="width: 80px;">è¯¦æƒ…</th>';
    html += '</tr></thead><tbody>';

    data.forEach((item, index) => {
        const priceChangeClass = item.price_change_pct >= 0 ? 'positive' : 'negative';
        const indexChangeClass = item.index_change_pct >= 0 ? 'positive' : 'negative';
        const deviationClass = item.deviation >= 0 ? 'positive' : 'negative';
        const rowId = `row-${period}-${index}`;

        // ä½¿ç”¨JSå‡½æ•°è®¡ç®—T+1å’ŒT+2çš„åç¦»å€¼
        // ç”Ÿæˆæ¨¡æ‹Ÿæ¶¨åœä»·æ ¼
        const lastPrice = item.stock_prices[item.stock_prices.length - 1].close;
        const limitUpPct = item.limit_up;

        // ä½¿ç”¨å®é™…çš„æ•°æ®é•¿åº¦ä½œä¸ºbaseDaysï¼Œè€Œä¸æ˜¯å‡è®¾çš„å€¼
        const actualBaseDays = item.stock_prices.length;

        // è·å–æœ€ä½ä»·
        let lowestPrice = item.stock_prices[0].pre_close;
        for (let i = 1; i < item.stock_prices.length; i++) {
            if (item.stock_prices[i].pre_close < lowestPrice) {
                lowestPrice = item.stock_prices[i].pre_close;
            }
        }

        const t1ExtraPrices = generateLimitUpPrices(lastPrice, limitUpPct, 1);
        const t2ExtraPrices = generateLimitUpPrices(lastPrice, limitUpPct, 2);

        const t1Result = calculateTrailingDeviation(item.stock_prices, item.index_prices, actualBaseDays, t1ExtraPrices);
        const t2Result = calculateTrailingDeviation(item.stock_prices, item.index_prices, actualBaseDays, t2ExtraPrices);

        const t1Deviation = t1Result.success ? t1Result.deviation : null;
        const t2Deviation = t2Result.success ? t2Result.deviation : null;

        // åˆ¤æ–­æ˜¯å¦å¼‚åŠ¨
        const threshold = item.threshold || 100;
        const t1IsAbnormal = t1Deviation !== null && t1Deviation > threshold;
        const t2IsAbnormal = t2Deviation !== null && t2Deviation > threshold;

        const t1DeviationClass = t1Deviation !== null && t1Deviation >= 0 ? 'positive' : 'negative';
        const t2DeviationClass = t2Deviation !== null && t2Deviation >= 0 ? 'positive' : 'negative';
        const t1AbnormalClass = t1IsAbnormal ? 'yes' : 'no';
        const t2AbnormalClass = t2IsAbnormal ? 'yes' : 'no';
        const t1AbnormalText = t1IsAbnormal ? 'âœ“' : 'âœ—';
        const t2AbnormalText = t2IsAbnormal ? 'âœ“' : 'âœ—';

        // ä¸»æ•°æ®è¡Œ - ä¸å†éœ€è¦å­˜å‚¨ data-* å±æ€§ï¼Œæ•°æ®å·²å­˜å‚¨åœ¨ JavaScript å˜é‡ä¸­
        html += `<tr data-ts-code="${item.ts_code}" data-period="${period}">`;
        html += `<td class="rank">${index + 1}</td>`;
        html += `<td style="font-weight: 600; color: var(--primary-color);">${item.ts_code}</td>`;
        html += `<td style="font-weight: 500;">${item.name}</td>`;
        html += `<td><span class="market-badge">${item.market}</span></td>`;
        html += `<td style="text-align: right; font-weight: 600;">${lastPrice.toFixed(2)}</td>`;
        html += `<td style="text-align: right; font-weight: 600;">${lowestPrice.toFixed(2)}</td>`;
        html += `<td><span class="${priceChangeClass}">${item.price_change_pct.toFixed(2)}%</span></td>`;
        html += `<td><span class="${indexChangeClass}">${item.index_change_pct.toFixed(2)}%</span></td>`;
        html += `<td><span class="${deviationClass}" style="font-weight: 700; font-size: 1.05em;">${item.deviation.toFixed(2)}%</span></td>`;
        html += `<td class="metrics-cell">
            <div class="metrics-row">
                <span class="metrics-label">T+1:</span>
                <span class="metrics-value ${t1DeviationClass}">${t1Deviation !== null ? t1Deviation.toFixed(2) : 'N/A'}%</span>
                <span class="abnormal-badge ${t1AbnormalClass}" style="margin-left: 4px;">${t1AbnormalText}</span>
            </div>
            <div class="metrics-row">
                <span class="metrics-label">T+2:</span>
                <span class="metrics-value ${t2DeviationClass}">${t2Deviation !== null ? t2Deviation.toFixed(2) : 'N/A'}%</span>
                <span class="abnormal-badge ${t2AbnormalClass}" style="margin-left: 4px;">${t2AbnormalText}</span>
            </div>
        </td>`;
        html += `<td style="text-align: center; font-weight: 600; color: var(--primary-color);">${item.deviation_date_range || 'N/A'}</td>`;
        html += `<td class="date-range">${item.low_date || 'N/A'} ~ ${item.end_date || 'N/A'}</td>`;
        html += `<td style="text-align: center;"><span class="expand-btn" onclick="toggleDetail('${rowId}')">â–¼ å±•å¼€</span></td>`;
        html += '</tr>';

        // è¯¦ç»†ä¿¡æ¯è¡Œ - ä½¿ç”¨JSè®¡ç®—çš„T+1åˆ°T+maxTPlusDaysæ•°æ®
        html += `<tr class="detail-row" id="${rowId}">`;
        html += `<td colspan="13">`;
        html += `<div class="detail-content">`;
        html += `<h4 style="margin-top: 0; color: var(--primary-color);">T+i åç¦»å€¼æ•°æ® (JSåŠ¨æ€è®¡ç®—)</h4>`;
        html += renderTPlusDataWithJSCalculation(item, maxTPlusDays, baseDays, item.threshold || 100, period);
        html += `</div>`;
        html += `</td>`;
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}





function showError(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="error-message">åŠ è½½å¤±è´¥: ${message}</div>`;
}

function renderTPlusDataWithJSCalculation(item, maxTPlusDays = 6, baseDays = 10, threshold = 100, period = 'period_10_new') {
    let html = '<div class="t-plus-grid" id="t-plus-grid-' + item.ts_code + '">';

    // è·å–æœ€åä¸€å¤©çš„æ”¶ç›˜ä»·å’Œæ¶¨åœå¹…åº¦
    const lastPrice = item.stock_prices[item.stock_prices.length - 1].close;
    const limitUpPct = item.limit_up;

    // ä½¿ç”¨å®é™…çš„æ•°æ®é•¿åº¦ä½œä¸ºbaseDaysï¼Œè€Œä¸æ˜¯å‚æ•°ä¸­çš„å€¼
    const actualBaseDays = item.stock_prices.length;

    // æ ¹æ®periodç¡®å®šä½¿ç”¨å“ªä¸ªä¿®æ”¹å­—å…¸
    const stockModifiedChanges = period.includes('30') ? stockModifiedChanges_30 : stockModifiedChanges_10;

    // è·å–è¯¥è‚¡ç¥¨çš„æ¶¨å¹…æ•°ç»„
    const tsCode = item.ts_code;
    const priceChanges = stockModifiedChanges[tsCode] || {};

    // æ ¹æ®ä¿®æ”¹åçš„æ¶¨å¹…æ•°ç»„è®¡ç®—è‚¡ä»·æ•°ç»„
    const allPrices = calculatePricesFromChanges(lastPrice, priceChanges, limitUpPct, maxTPlusDays);

    // æ¸²æŸ“ t+1 åˆ° t+maxTPlusDaysï¼Œä½¿ç”¨JSå‡½æ•°åŠ¨æ€è®¡ç®—
    for (let i = 1; i <= maxTPlusDays; i++) {
        // æ„å»ºåˆ°ç¬¬ i å¤©çš„å®Œæ•´ä»·æ ¼åºåˆ—
        const extraPrices = allPrices.slice(0, i);
        const result = calculateTrailingDeviation(item.stock_prices, item.index_prices, actualBaseDays, extraPrices);

        if (result.success) {
            const stockChangePercent = result.stock.changePercent;
            const indexChangePercent = result.index.changePercent;
            const deviation = result.deviation;

            // è®¡ç®—å½“æ—¥æ¶¨å¹…ï¼ˆT+nç›¸å¯¹äºT+n-1çš„æ¶¨å¹…ï¼‰
            let dailyChangePercent = 0;
            if (i === 1) {
                // T+1çš„å½“æ—¥æ¶¨å¹… = (T+1æ”¶ç›˜ä»· - æœ€åä¸€å¤©æ”¶ç›˜ä»·) / æœ€åä¸€å¤©æ”¶ç›˜ä»· * 100
                dailyChangePercent = ((extraPrices[0] - lastPrice) / lastPrice) * 100;
            } else {
                // T+nçš„å½“æ—¥æ¶¨å¹… = (T+næ”¶ç›˜ä»· - T+n-1æ”¶ç›˜ä»·) / T+n-1æ”¶ç›˜ä»· * 100
                const prevPrice = extraPrices[i - 2];
                dailyChangePercent = ((extraPrices[i - 1] - prevPrice) / prevPrice) * 100;
            }

            // åˆ¤æ–­æ˜¯å¦å¼‚åŠ¨
            const isAbnormal = deviation > threshold;

            const priceChangeClass = stockChangePercent >= 0 ? 'positive' : 'negative';
            const dailyChangeClass = dailyChangePercent >= 0 ? 'positive' : 'negative';
            const deviationClass = deviation >= 0 ? 'positive' : 'negative';
            const abnormalClass = isAbnormal ? 'yes' : 'no';
            const abnormalText = isAbnormal ? 'æ˜¯' : 'å¦';

            // è®¡ç®—å¯èƒ½çš„æœ€é«˜ä»·æ ¼å’Œå¯èƒ½çš„næ—¥æ¶¨å¹…
            // å¼‚åŠ¨å¹…åº¦ä¸ºthresholdï¼ˆ10æ—¥æ¦œ100%ï¼Œ30æ—¥æ¦œ200%ï¼‰
            const possiblePriceData = calculatePossibleHighestPrice(
              result.stock.lowestPreClose,
              item.threshold || 100,
              result.index.changePercent,
              lastPrice
            );
            const possibleHighestPrice = possiblePriceData.possibleHighestPrice;
            const possibleNDayChange = possiblePriceData.possibleNDayChange;
            const possibleChangeClass = possibleNDayChange >= 0 ? 'positive' : 'negative';

            const cardId = `t-plus-card-${period}-${item.ts_code}-${i}`;
            html += `<div class="t-plus-card" id="${cardId}">`;
            html += `<div class="t-plus-title">T+${i} <button class="edit-btn" onclick="openEditModal('${item.ts_code}', ${i}, ${limitUpPct}, ${lastPrice}, ${baseDays}, ${maxTPlusDays}, '${period}')">âœï¸ ä¿®æ”¹</button></div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æœ€ä½ä»·:</span>`;
            html += `<span class="t-plus-value">${result.stock.lowestPreClose.toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ—¥æœŸ:</span>`;
            html += `<span class="t-plus-value">${result.stock.lowestDate}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ¶¨åœä»·:</span>`;
            html += `<span class="t-plus-value" id="current-close-${period}-${item.ts_code}-${i}">${result.stock.currentClose.toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value ${priceChangeClass}" id="price-change-${period}-${item.ts_code}-${i}">${stockChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å½“æ—¥æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value ${dailyChangeClass}" id="daily-change-${period}-${item.ts_code}-${i}">${dailyChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">æŒ‡æ•°æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value" id="index-change-${period}-${item.ts_code}-${i}">${indexChangePercent.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">åç¦»å€¼:</span>`;
            html += `<span class="t-plus-value ${deviationClass}" id="deviation-${period}-${item.ts_code}-${i}">${deviation.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å¼‚åŠ¨:</span>`;
            html += `<span class="abnormal-badge ${abnormalClass}" id="abnormal-${period}-${item.ts_code}-${i}">${abnormalText}</span>`;
            html += `</div>`;
            html += `<div class="metrics-divider"></div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å¯èƒ½æœ€é«˜ä»·:</span>`;
            html += `<span class="t-plus-value" id="possible-highest-${period}-${item.ts_code}-${i}">${possibleHighestPrice.toFixed(2)}</span>`;
            html += `</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">å¯èƒ½æ¶¨å¹…:</span>`;
            html += `<span class="t-plus-value ${possibleChangeClass}" id="possible-change-${period}-${item.ts_code}-${i}">${possibleNDayChange.toFixed(2)}%</span>`;
            html += `</div>`;
            html += `</div>`;
        } else {
            html += `<div class="t-plus-card">`;
            html += `<div class="t-plus-title">T+${i}</div>`;
            html += `<div class="t-plus-item">`;
            html += `<span class="t-plus-label">é”™è¯¯:</span>`;
            html += `<span class="t-plus-value">${result.error}</span>`;
            html += `</div>`;
            html += `</div>`;
        }
    }

    html += '</div>';
    return html;
}



function toggleDetail(rowId) {
    const detailRow = document.getElementById(rowId);
    const btn = event.target;

    if (detailRow.classList.contains('show')) {
        detailRow.classList.remove('show');
        btn.textContent = 'â–¼ å±•å¼€';
    } else {
        detailRow.classList.add('show');
        btn.textContent = 'â–² æ”¶èµ·';
    }
}

// ==================== æ•°æ®å­˜å‚¨ ====================
// ä½¿ç”¨ JavaScript å˜é‡å­˜å‚¨æ‰€æœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯ä¾èµ– HTML data-* å±æ€§

// å­˜å‚¨ä»åç«¯è¿”å›çš„åŸå§‹æ•°æ®
const stocksData_10 = [];  // 10æ—¥æ¦œå•çš„åŸå§‹æ•°æ®
const stocksData_30 = [];  // 30æ—¥æ¦œå•çš„åŸå§‹æ•°æ®

// å­˜å‚¨æ¯ä¸ªè‚¡ç¥¨çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨äºå¿«é€ŸæŸ¥æ‰¾ï¼‰
// æ ¼å¼: { 'period_10_new': { 'tsCode': { stock_prices: [...], index_prices: [...], ... } } }
const stockDetailsMap = {
    'period_10_new': {},
    'period_30_new': {}
};

// ä¸º10æ—¥å’Œ30æ—¥æ¦œå•åˆ†åˆ«åˆ›å»ºä¸åŒçš„å­—å…¸æ¥å­˜å‚¨ä¿®æ”¹åçš„æ¶¨å¹…æ•°æ®
// æ ¼å¼: { 'tsCode': { 1: 5.0, 2: 3.5, ... } }  // keyæ˜¯T+nçš„å¤©æ•°ï¼Œvalueæ˜¯ä¿®æ”¹åçš„å½“æ—¥æ¶¨å¹…
const stockModifiedChanges_10 = {};  // 10æ—¥æ¦œå•çš„ä¿®æ”¹æ•°æ®
const stockModifiedChanges_30 = {};  // 30æ—¥æ¦œå•çš„ä¿®æ”¹æ•°æ®

let currentEditData = {
    tsCode: null,
    tPlusDay: null,
    limitUpPct: null,
    lastPrice: null,
    baseDays: null,
    maxTPlusDays: null,
    period: null,
    modifiedPrices: {} // å­˜å‚¨ä¿®æ”¹åçš„æ¶¨å¹…
};

function openEditModal(tsCode, tPlusDay, limitUpPct, lastPrice, baseDays, maxTPlusDays, period) {
    // ä» JavaScript å˜é‡è·å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä» HTML data-* å±æ€§
    const stockDetails = stockDetailsMap[period][tsCode];

    if (!stockDetails) {
        console.error('æœªæ‰¾åˆ°è‚¡ç¥¨æ•°æ®:', tsCode, period);
        return;
    }

    const threshold = stockDetails.threshold;
    const stockPrices = stockDetails.stock_prices;
    const indexPrices = stockDetails.index_prices;

    // æ ¹æ®periodç¡®å®šä½¿ç”¨å“ªä¸ªä¿®æ”¹å­—å…¸
    const stockModifiedChanges = period.includes('30') ? stockModifiedChanges_30 : stockModifiedChanges_10;

    currentEditData = {
        tsCode: tsCode,
        tPlusDay: tPlusDay,
        limitUpPct: limitUpPct,
        lastPrice: lastPrice,
        baseDays: baseDays,
        maxTPlusDays: maxTPlusDays,
        threshold: threshold,
        stockPrices: stockPrices,
        indexPrices: indexPrices,
        period: period,
        stockModifiedChanges: stockModifiedChanges
    };

    // è·å–å½“å‰çš„å½“æ—¥æ¶¨å¹…å€¼ï¼ˆä»ä¿®æ”¹å­—å…¸ä¸­è·å–ï¼‰
    const currentValue = stockModifiedChanges[tsCode] && stockModifiedChanges[tsCode][tPlusDay]
        ? stockModifiedChanges[tsCode][tPlusDay]
        : limitUpPct;

    // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
    document.getElementById('editModalTitle').textContent = `ä¿®æ”¹ ${tsCode} T+${tPlusDay} å½“æ—¥æ¶¨å¹…`;
    document.getElementById('priceChangeInput').value = currentValue.toFixed(2);

    // è®¾ç½®èŒƒå›´æç¤º
    const minValue = -limitUpPct;
    const maxValue = limitUpPct;
    document.getElementById('rangeHint').textContent = `èŒƒå›´: ${minValue.toFixed(2)}% ~ ${maxValue.toFixed(2)}%`;

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function saveModification() {
    const newValue = parseFloat(document.getElementById('priceChangeInput').value);
    const limitUpPct = currentEditData.limitUpPct;
    const minValue = -limitUpPct;
    const maxValue = limitUpPct;

    // éªŒè¯è¾“å…¥
    if (isNaN(newValue)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
        return;
    }

    if (newValue < minValue || newValue > maxValue) {
        alert(`æ¶¨å¹…å¿…é¡»åœ¨ ${minValue.toFixed(2)}% åˆ° ${maxValue.toFixed(2)}% ä¹‹é—´`);
        return;
    }

    // ä¿å­˜ä¿®æ”¹å¹¶é‡æ–°è®¡ç®—åç»­æ•°æ®
    recalculateTPlusData(newValue);
    closeEditModal();
}

/**
 * æ ¹æ®ä¿®æ”¹åçš„æ¶¨å¹…æ•°ç»„è®¡ç®—è‚¡ä»·æ•°ç»„
 * @param {number} basePrice - åŸºç¡€ä»·æ ¼ï¼ˆæœ€åä¸€å¤©çš„æ”¶ç›˜ä»·ï¼‰
 * @param {Object} modifiedChanges - ä¿®æ”¹åçš„æ¶¨å¹…æ•°æ® { 1: 5.0, 2: 3.5, ... }
 * @param {number} limitUpPct - é»˜è®¤æ¶¨åœå¹…åº¦
 * @param {number} maxDays - æœ€å¤§å¤©æ•°
 * @returns {Array} è®¡ç®—åçš„è‚¡ä»·æ•°ç»„
 */
function calculatePricesFromChanges(basePrice, modifiedChanges, limitUpPct, maxDays) {
    const prices = [];

    for (let i = 1; i <= maxDays; i++) {
        const prevPrice = i === 1 ? basePrice : prices[i - 2];

        // è·å–è¯¥å¤©çš„æ¶¨å¹…ï¼ˆä¼˜å…ˆä½¿ç”¨ä¿®æ”¹åçš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ¶¨åœå¹…åº¦ï¼‰
        const dailyChange = modifiedChanges[i] !== undefined ? modifiedChanges[i] : limitUpPct;

        // è®¡ç®—è¯¥å¤©çš„è‚¡ä»·
        const price = parseFloat((prevPrice * (1 + dailyChange / 100)).toFixed(2));
        prices.push(price);
    }

    return prices;
}

function recalculateTPlusData(modifiedDailyChange) {
    const { tsCode, tPlusDay, limitUpPct, baseDays, maxTPlusDays, threshold, stockPrices, indexPrices, lastPrice, stockModifiedChanges, period } = currentEditData;

    // ä½¿ç”¨å®é™…çš„æ•°æ®é•¿åº¦ä½œä¸ºbaseDays
    const actualBaseDays = stockPrices.length;

    // ä¿å­˜æœ¬æ¬¡ä¿®æ”¹çš„æ¶¨å¹…åˆ°å¯¹åº”çš„å­—å…¸
    stockModifiedChanges[tsCode][tPlusDay] = modifiedDailyChange;

    // æ ¹æ®ä¿®æ”¹åçš„æ¶¨å¹…æ•°ç»„è®¡ç®—è‚¡ä»·æ•°ç»„
    const allPrices = calculatePricesFromChanges(lastPrice, stockModifiedChanges[tsCode], limitUpPct, maxTPlusDays);

    // é‡æ–°è®¡ç®— T+1 åˆ° T+maxTPlusDays çš„æ•°æ®
    for (let i = 1; i <= maxTPlusDays; i++) {
        // æ„å»ºåˆ°ç¬¬ i å¤©çš„å®Œæ•´ä»·æ ¼åºåˆ—ï¼ˆç”¨äºè®¡ç®—åç¦»å€¼ï¼‰
        const extraPrices = allPrices.slice(0, i);

        // è®¡ç®—åç¦»å€¼
        const result = calculateTrailingDeviation(stockPrices, indexPrices, actualBaseDays, extraPrices);

        if (result.success) {
            const stockChangePercent = result.stock.changePercent;
            const indexChangePercent = result.index.changePercent;
            const deviation = result.deviation;
            const isAbnormal = deviation > threshold;

            // è®¡ç®—å½“æ—¥æ¶¨å¹…
            let dailyChangePercent = 0;
            const currentPrice = extraPrices[extraPrices.length - 1]; // å½“å‰å¤©çš„ä»·æ ¼
            let prevDayPrice;

            if (i === 1) {
                // T+1çš„å‰ä¸€å¤©æ˜¯T+0ï¼ˆlastPriceï¼‰
                prevDayPrice = lastPrice;
            } else {
                // å…¶ä»–å¤©æ•°çš„å‰ä¸€å¤©ä»·æ ¼
                prevDayPrice = extraPrices[extraPrices.length - 2];
            }

            dailyChangePercent = ((currentPrice - prevDayPrice) / prevDayPrice) * 100;

            // è®¡ç®—å¯èƒ½çš„æœ€é«˜ä»·æ ¼å’Œå¯èƒ½çš„næ—¥æ¶¨å¹…
            // å¼‚åŠ¨å¹…åº¦ä¸ºthresholdï¼ˆ10æ—¥æ¦œ100%ï¼Œ30æ—¥æ¦œ200%ï¼‰
            const possiblePriceData = calculatePossibleHighestPrice(
              result.stock.lowestPreClose,
              threshold,
              indexChangePercent,
              lastPrice
            );
            const possibleHighestPrice = possiblePriceData.possibleHighestPrice;
            const possibleNDayChange = possiblePriceData.possibleNDayChange;

            // æ›´æ–°UI - ä½¿ç”¨åŒ…å« period çš„ ID æ¥åŒºåˆ†ä¸åŒæ¦œå•
            const currentCloseElement = document.getElementById(`current-close-${period}-${tsCode}-${i}`);
            const priceChangeElement = document.getElementById(`price-change-${period}-${tsCode}-${i}`);
            const dailyChangeElement = document.getElementById(`daily-change-${period}-${tsCode}-${i}`);
            const indexChangeElement = document.getElementById(`index-change-${period}-${tsCode}-${i}`);
            const deviationElement = document.getElementById(`deviation-${period}-${tsCode}-${i}`);
            const abnormalElement = document.getElementById(`abnormal-${period}-${tsCode}-${i}`);
            const possibleHighestElement = document.getElementById(`possible-highest-${period}-${tsCode}-${i}`);
            const possibleChangeElement = document.getElementById(`possible-change-${period}-${tsCode}-${i}`);

            if (currentCloseElement) {
                currentCloseElement.textContent = result.stock.currentClose.toFixed(2);
            }

            if (priceChangeElement) {
                priceChangeElement.textContent = stockChangePercent.toFixed(2) + '%';
                priceChangeElement.className = `t-plus-value ${stockChangePercent >= 0 ? 'positive' : 'negative'}`;
            }

            if (dailyChangeElement) {
                dailyChangeElement.textContent = dailyChangePercent.toFixed(2) + '%';
                dailyChangeElement.className = `t-plus-value ${dailyChangePercent >= 0 ? 'positive' : 'negative'}`;
            }

            if (indexChangeElement) {
                indexChangeElement.textContent = indexChangePercent.toFixed(2) + '%';
            }

            if (deviationElement) {
                deviationElement.textContent = deviation.toFixed(2) + '%';
                deviationElement.className = `t-plus-value ${deviation >= 0 ? 'positive' : 'negative'}`;
            }

            if (abnormalElement) {
                abnormalElement.textContent = isAbnormal ? 'æ˜¯' : 'å¦';
                abnormalElement.className = `abnormal-badge ${isAbnormal ? 'yes' : 'no'}`;
            }

            if (possibleHighestElement) {
                possibleHighestElement.textContent = possibleHighestPrice.toFixed(2);
            }

            if (possibleChangeElement) {
                possibleChangeElement.textContent = possibleNDayChange.toFixed(2) + '%';
                possibleChangeElement.className = `t-plus-value ${possibleNDayChange >= 0 ? 'positive' : 'negative'}`;
            }
        }
    }
}

/**
 * ä¸ºæ‰€æœ‰ T+n å¡ç‰‡æ·»åŠ å¦ä¸€æ¦œå•çš„å¼‚åŠ¨ä¿¡æ¯
 * åœ¨ä¸¤ä¸ªæ¦œå•éƒ½æ¸²æŸ“å®Œæˆåè°ƒç”¨
 */
function addCrossListAbnormalInfo() {
    // éå†10æ—¥æ¦œå•çš„æ‰€æœ‰è‚¡ç¥¨
    stocksData_10.forEach((item) => {
        const tsCode = item.ts_code;
        // æŸ¥è¯¢è¯¥è‚¡ç¥¨åœ¨30æ—¥æ¦œå•ä¸­çš„ä¿¡æ¯
        addAbnormalInfoToCards(tsCode, 'period_10_new', 'period_30_new', stocksData_30);
    });

    // éå†30æ—¥æ¦œå•çš„æ‰€æœ‰è‚¡ç¥¨
    stocksData_30.forEach((item) => {
        const tsCode = item.ts_code;
        // æŸ¥è¯¢è¯¥è‚¡ç¥¨åœ¨10æ—¥æ¦œå•ä¸­çš„ä¿¡æ¯
        addAbnormalInfoToCards(tsCode, 'period_30_new', 'period_10_new', stocksData_10);
    });
}

/**
 * ä¸ºæŒ‡å®šè‚¡ç¥¨çš„æ‰€æœ‰ T+n å¡ç‰‡æ·»åŠ å¦ä¸€æ¦œå•çš„å¼‚åŠ¨ä¿¡æ¯
 * @param {string} tsCode - è‚¡ç¥¨ä»£ç 
 * @param {string} currentPeriod - å½“å‰æ¦œå• (period_10_new æˆ– period_30_new)
 * @param {string} otherPeriod - å¦ä¸€æ¦œå• (period_30_new æˆ– period_10_new)
 * @param {Array} otherStocksData - å¦ä¸€æ¦œå•çš„è‚¡ç¥¨æ•°æ®
 */
function addAbnormalInfoToCards(tsCode, currentPeriod, otherPeriod, otherStocksData) {
    // æŸ¥æ‰¾è¯¥è‚¡ç¥¨åœ¨å¦ä¸€æ¦œå•ä¸­æ˜¯å¦å­˜åœ¨
    const otherStock = otherStocksData.find(stock => stock.ts_code === tsCode);

    // è·å–å½“å‰æ¦œå•çš„è‚¡ç¥¨è¯¦ç»†ä¿¡æ¯
    const currentStockDetails = stockDetailsMap[currentPeriod][tsCode];
    if (!currentStockDetails) {
        return;
    }

    const maxTPlusDays = currentStockDetails.max_t_plus_days;

    // ä¸ºæ¯ä¸ª T+n å¡ç‰‡æ·»åŠ ä¿¡æ¯
    for (let i = 1; i <= maxTPlusDays; i++) {
        const cardId = `t-plus-card-${currentPeriod}-${tsCode}-${i}`;
        const card = document.getElementById(cardId);

        if (!card) {
            continue;
        }

        let html = '';

        if (!otherStock) {
            // è¯¥è‚¡ç¥¨ä¸åœ¨å¦ä¸€æ¦œå•ä¸­
            html = `
                <div class="metrics-divider"></div>
                <div class="t-plus-item">
                    <span class="t-plus-label">å¦ä¸€æ¦œå•:</span>
                    <span class="t-plus-value" style="color: #999;">æ— å¼‚åŠ¨</span>
                </div>
            `;
        } else {
            // è¯¥è‚¡ç¥¨åœ¨å¦ä¸€æ¦œå•ä¸­ï¼Œè®¡ç®—å…¶ T+i çš„å¼‚åŠ¨æƒ…å†µ
            const otherStockDetails = stockDetailsMap[otherPeriod][tsCode];
            if (!otherStockDetails) {
                return;
            }

            const otherStockModifiedChanges = otherPeriod.includes('30') ? stockModifiedChanges_30 : stockModifiedChanges_10;
            const otherPriceChanges = otherStockModifiedChanges[tsCode] || {};
            const otherLimitUpPct = otherStockDetails.limit_up;
            const otherLastPrice = otherStockDetails.last_price;
            const otherThreshold = otherStockDetails.threshold;
            const otherBaseDays = otherStockDetails.base_days;

            // è®¡ç®—å¦ä¸€æ¦œå•çš„ T+i ä»·æ ¼æ•°ç»„
            const otherAllPrices = calculatePricesFromChanges(otherLastPrice, otherPriceChanges, otherLimitUpPct, maxTPlusDays);
            const otherExtraPrices = otherAllPrices.slice(0, i);

            // è®¡ç®—å¦ä¸€æ¦œå•çš„ T+i åç¦»å€¼
            const otherResult = calculateTrailingDeviation(
                otherStock.stock_prices,
                otherStock.index_prices,
                otherBaseDays,
                otherExtraPrices
            );

            if (otherResult.success) {
                const otherDeviation = otherResult.deviation;
                const otherIsAbnormal = otherDeviation > otherThreshold;

                // è®¡ç®—å¯èƒ½çš„æœ€é«˜æ¶¨å¹…
                const otherPossiblePriceData = calculatePossibleHighestPrice(
                    otherResult.stock.lowestPreClose,
                    otherThreshold,
                    otherResult.index.changePercent,
                    otherLastPrice
                );
                const otherPossibleNDayChange = otherPossiblePriceData.possibleNDayChange;

                const otherDeviationClass = otherDeviation >= 0 ? 'positive' : 'negative';
                const otherAbnormalClass = otherIsAbnormal ? 'yes' : 'no';
                const otherAbnormalText = otherIsAbnormal ? 'æ˜¯' : 'å¦';
                const otherPossibleChangeClass = otherPossibleNDayChange >= 0 ? 'positive' : 'negative';

                const otherPeriodLabel = otherPeriod.includes('30') ? '30æ—¥æ¦œ' : '10æ—¥æ¦œ';

                html = `
                    <div class="metrics-divider"></div>
                    <div class="t-plus-item">
                        <span class="t-plus-label">${otherPeriodLabel}å¼‚åŠ¨:</span>
                        <span class="abnormal-badge ${otherAbnormalClass}">${otherAbnormalText}</span>
                    </div>
                `;

                // åªæœ‰åœ¨å¼‚åŠ¨æ—¶æ‰æ˜¾ç¤ºå¯èƒ½æœ€é«˜æ¶¨å¹…
                if (otherIsAbnormal) {
                    html += `
                        <div class="t-plus-item">
                            <span class="t-plus-label">å¯èƒ½æœ€é«˜æ¶¨å¹…:</span>
                            <span class="t-plus-value ${otherPossibleChangeClass}">${otherPossibleNDayChange.toFixed(2)}%</span>
                        </div>
                    `;
                }
            } else {
                // è®¡ç®—å¤±è´¥
                html = `
                    <div class="metrics-divider"></div>
                    <div class="t-plus-item">
                        <span class="t-plus-label">å¦ä¸€æ¦œå•:</span>
                        <span class="t-plus-value" style="color: #999;">è®¡ç®—å¤±è´¥</span>
                    </div>
                `;
            }
        }

        // å°† HTML æ’å…¥åˆ°å¡ç‰‡æœ«å°¾
        card.insertAdjacentHTML('beforeend', html);
    }
}

// å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶ç›‘å¬
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.addEventListener('mousedown', function(event) {
            if (event.target === modal) {
                closeEditModal();
            }
        });
    }

    // å›è½¦ä¿å­˜
    const input = document.getElementById('priceChangeInput');
    if (input) {
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                saveModification();
            }
        });
    }
});
</script>

<!-- ä¿®æ”¹æ¶¨å¹…çš„æ¨¡æ€æ¡† -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="editModalTitle">ä¿®æ”¹æ¶¨å¹…</div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">ä¿®æ”¹æ¶¨å¹… (%)</label>
                <input type="number" id="priceChangeInput" class="form-input" step="0.01" placeholder="è¾“å…¥æ¶¨å¹…ç™¾åˆ†æ¯”">
                <div class="form-hint" id="rangeHint">èŒƒå›´: -10% ~ 50%</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveModification()">ä¿å­˜</button>
        </div>
    </div>
</div>

{% endblock %}

